(struct Template "HTML Templates"
	[::site-name := Config::site-name]
	[::make-header := (lambda (context title)
		(join-string (~include "header.html") "")
	)]

    [::build-posts := (lambda (posts start is-comment)
        (var table clone "<div class='lister'>")
        (var zebra false)
        (var length len posts)

        (roop posts [(post i) =>
            (var title post::title)
            (var id post::id)
            (var no + (- length i) start)

            (if [post::state == "deleted"] 
                (set title "<span red>[deleted]</span>"))

            (+. table
"<div class='item item-" (str (set zebra (not zebra))) "' id='item-" id "'>
    <div class='title'>" 
        (if is-comment 
            title
            (+ "<b>" (str no) "</b>. <a href='/item/" id "'>" title "</a>"))
        (if [post::state == "locked"]
            "<span locked>locked</span>")
    "</div>
    <div class='info'>#" post::id " | " post::comments " comments" 
        (if [post::comments > 0] 
            (+ " (" (pretty-date post::commented-ts) " ago)"))
            " | <span points>" post::points "</span> points | "
            "by <a href='/user/" post::author "'>" post::author "</a> at " (pretty-date post::created-ts) " ago | "
        (if is-comment 
            (+ "<a href='/item/" id "'>view</a> | "))
            "<a class='hider' href='javascript:hide(" id ")'>hide</a>
    </div>
</div>")
        ])
        (+. table "</div>")
        (table)
    )]

    [::build-pager := (lambda (start size)
        (var ppp Config::posts-per-page)
        (var prev - start ppp)
        (var next + start ppp)
        (var ret "<div class='banner'>")
        
        (if [prev >= 0]
            (set ret + ret "<a class='nav' href='?after=" (str prev) "'>&laquo; prev</a>"))

        (set ret + ret "<a class='nav' href='?after=" (str next) "'>next &raquo;</a>")

        (+ ret "</div>")
    )]

	[::index := (lambda (context posts start)
        (var index (join-string (~include "index.html") ""))
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context "Index") (sprintf index (::build-posts posts start false)) footer)
    )]

    [::item := (lambda (context item comments start)
        (var item-id (str item::id))
        (var item-page (join-string (~include "item.html") ""))
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context item::title) (sprintf item-page (::build-posts comments start true)) footer)
    )]

	[::submit := (lambda (context)
        (var submit (join-string (~include "submit.html") ""))
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context "Submit") submit footer)
     )]

	[::login := (lambda (context)
        (var login (join-string (~include "login.html") ""))
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context "Login") login footer)
    )]

	[::welcome := (lambda (context)
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context "Welcome") (sprintf 
            "<div class='welcome'>Welcome %s! Back to <a href='/'>timeline</a></div>"
            context::username) footer)
    )]

    [::member-info := (lambda (context user-data)
        (var sign-up (num [user-data : UserOp::SIGN_UP_TS]))
        (var age / [(time 1) - sign-up] 86400000)
        (var username [user-data : UserOp::USERNAME])
        (var member-info (join-string (~include "member.html") ""))
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context username) member-info footer)
    )]

    [::user-info := (lambda (context user-data)
        (var sign-up (num [user-data : UserOp::SIGN_UP_TS]))
        (var age / [(time 1) - sign-up] 86400000)
        (var user-info (join-string (~include "user.html") ""))
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context "User") user-info footer)
    )]

    [::lister := (lambda (context posts page-title start)
        (var list-page (join-string (~include "list.html") ""))
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context page-title) (sprintf list-page (::build-posts posts start false)) footer)
    )]

    [::error := (lambda (context text)
        (var footer (join-string (~include "footer.html") ""))

        (+ (::make-header context "Error") "<div class='error' onclick='history.go(-1)'>" 
            text "</div>" footer)
    )]
)