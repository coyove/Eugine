(def calc-rank (lst)
	(var idx 1)
	(var points 0.0)
	(var limit 100.0)

	(loop [idx < (len lst)] [() =>
		(var karma + 0.0 (num [lst : idx]))

		(cond true
			([karma > limit] (+= points 1.0))
			([karma > 9] (+= points (pow [karma / limit] 0.9)))
			(_ ()))

		(if [[lst : (- idx 1)] == "~fixed"]
		    { (set points karma) false }
		    (+= idx 3))
	])

	(floor points)
)

(def update-list (list-file id ops...)
	(var sid + (str id) " ")
    (var lines read-file-lines list-file)

    (if [lines != null]
        (loop lines [(item i) =>
            (if [item starts-with sid] {
                (var parts split item " ")

                (loop ops [(op) =>
                    (var idx [op : 0])
                    (set [parts : idx] ([op : 1] [parts : idx]))
                ])

                (set [lines : i] join-string parts " ")
            })
        ]))

	(write-file list-file lines)
)

(def recalc-points-of-item (id aye no)
	(var path get-post-path id)

	; (var aye read-file-lines (+ path "/aye"))
	(var aye-count len aye)
	(var aye-points calc-rank aye)

	; (var no read-file-lines (+ path "/no"))
	(var no-count len no)
	(var no-points calc-rank no)

	(var points (- aye-points no-points))

	;; update the item data
	(var data read-file-lines (+ path "/data"))
	(var old-points num [data : 6])
	(set [data : 6] (str points))
	(set [data : 7] (str (/ aye-count 2)))
	(set [data : 8] (str (/ no-count 2)))
	(write-file (+ path "/data") data)

	;; update item's author data
	(var user-dp UserOp::get-data-path [data : 0])
	(var user-data read-file-lines user-dp)
	(var karma num [user-data : UserOp::KARMA])
	(set [user-data : UserOp::KARMA] (str [[karma - old-points] + points]))
	(write-file user-dp user-data)

	(var user-list UserOp::get-user-path [data : 0])

	(if [[data : 9] != "0"] {
		;; update item's parent's list
		(var path get-post-path (num [data : 9]))
		(+= user-list "/comments-list")
	} {
		;; update main list
		(var path (+ ~path "data/posts/" (str (/ id 1000))))
		(+= user-list "/submits-list")
	})

	(update-list (+ path "/list") id (2 [() => (str points)]))
	(update-list user-list id (2 [() => (str points)]))
)

(def ranking ()
    (var newest (num (read-file (+ ~path "data/posts/main-index"))))
    (var gap1 / newest 1000)
    (var gap2 - gap1 1)

    (var data1 read-file-lines (+ ~path "data/posts/" (str gap1) "/list"))
    (if [data1 == null] (set data1 (list)))

    (var data2 read-file-lines (+ ~path "data/posts/" (str gap2) "/list"))
    (if [data2 == null] (set data2 (list)))

    (var posts + data1 (explode data2))
    (try {
        (loop posts [(post i) =>
            (var parts (split post " "))
            (if [(len parts) != 9] (exit 30))

            (var p clone Post (explode parts))
            (var T / [(time 1) - (num p::created-ts)] 3600000)

            (var R [(num p::points) / (pow [T + 2] 1.8)])
            (var p::~comparator R)
            (set [posts : i] p)
        ])
    } () (cond ~e
        (30
            (set posts (list))
            (println "Corrupted index file: " file))
    ))

    (sort posts)
    (var output (list))
    (loop posts [(post) =>
        (+. output (+ (str post::id) " " (str post::comments) " " (str post::points) " "
            post::state " " post::author " " post::commenter " "
            (str post::created-ts) " " (str post::commented-ts) " " (encodeURI post::title)))
    ])

    (write-file (+ ~path "data/posts/ranking") output)
)