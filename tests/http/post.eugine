(if [id != 0] {
	(var parent-dir get-post-path id)
	(if (file-exists parent-dir) {
		(var parent-data (read-file-lines (+ parent-dir "/data")))
		(if [[parent-data : 4] == "locked"] (exit 40))
	} (exit 41))
})

(var post-dir (+ ~path "data/posts/" (str [next-id / 1000]) "/" (str next-id)))
(make-dir post-dir)

(var ts (time 1))
(var data (list
	author		; author
	(encodeURI title)		; title, escaped
	(str ts)	; created ts
	(str ts)	; modified ts
	"open"		; state
	"0"			; comments
	"0"			; points
	"0"			; aye count
	"0"			; no count
	(str id)	; parent
))

(write-file (+ post-dir "/data") data)
(write-file (+ post-dir "/raw") text)
(write-file (+ post-dir "/aye") "")
(write-file (+ post-dir "/no") "")

(if context::is-logged-in {
	(var user-dp UserOp::get-data-path context::username)
	(var user-data read-file-lines user-dp)
	(var total-posts num [user-data : UserOp::TOTAL_POSTS])
	(set [user-data : UserOp::TOTAL_POSTS] (str (++ total-posts)))
	(write-file user-dp user-data)
})

(if [id != 0] {

	(if (file-exists parent-dir) {
		(create-if-not-exist (+ parent-dir "/list") "")
		(var liner + (str next-id) " 0 0 open " author " " author " " (str ts) " " (str ts) " " (encodeURI text) "\n")
		(append-file (+ parent-dir "/list") liner)

		(var user-list UserOp::get-user-path context::username)
        (create-if-not-exist (+ user-list "/comments-list") "")
        (append-file (+ user-list "/comments-list") liner)

		(set parent-comments num [parent-data : 5])
		(set [parent-data : 5] (str (++ parent-comments)))
		(write-file (+ parent-dir "/data") parent-data)

        (var parent-user-list UserOp::get-user-path [parent-data : 0])

		(if [[parent-data : 9] != "0"] {
			(var parent-parent-id num [parent-data : 9])
			(var pp-dir get-post-path parent-parent-id)
		    (+= parent-user-list "/comments-list")
		} {
			(var pp-dir (+ ~path "data/posts/" (str (/ id 1000))))
			(+= parent-user-list "/submissions-list")
		})

		(update-list (+ pp-dir "/list") id
		    (1 [(count) => (str (+ (num count) 1))])
		    (7 [() => (str ts)]))

		(update-list parent-user-list id
            (1 [(count) => (str (+ (num count) 1))])
            (7 [() => (str ts)]))
	})

	(var return-to (+ "/item/" (str id)))
} {
	(var posts-dir (+ ~path "data/posts/" (str [next-id / 1000])))
	(create-if-not-exist (+ posts-dir "/list") "")
	(var liner + (str next-id) " 0 0 open " author " " author " " (str ts) " " (str ts) " " (encodeURI title) "\n")
	(append-file (+ posts-dir "/list") liner)

	(var user-list UserOp::get-user-path context::username)
    (create-if-not-exist (+ user-list "/submissions-list") "")
    (append-file (+ user-list "/submissions-list") liner)

	(var return-to "/")
})