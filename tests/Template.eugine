(def Template() => {
    def header(title) => @"<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='referrer' content='origin'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAKlBMVEVLWX3///9seJVyfZlaZ4heaopUYYS8wc7b3uVjb47x8vXT1t96hJ/8/Pwv3cUDAAAAOklEQVR4XmOgH5hsDAZmcIFGQTAQxy2wEV3AxcVHUDA0NIABDhiYBAUZGBhGrADnRSm0cGZLYKAeAABwbwqMNFT1HQAAAABJRU5ErkJggg==' rel='icon' type='image/x-icon'>
    <link rel='stylesheet' type='text/css' href='/assets/style.css'>
    <script type='text/javascript' src='/assets/main.js'></script>
    <title>" + title + " | " + Config.siteName + @"</title>
</head>
<body>
    <div id='container'>"

    def footer() => @"
    </div>
</body>"

    def _post(id, action, fields) => {
        var ret = @"
<form action='" + action + "' id='" + id + @"' method='post'>
    <table>"
        for fields do (f) => 
            ret <+ ("<tr><td>" + f.text + "</td><td>" + ({
                text: 
                    "<input type='text' name='" + f.name + "' id='" + f.name + "'/>",
                textarea: 
                    "<textarea name='" + f.name + "' id='" + f.name + "' rows='" + f.rows + "'></textarea>",
                checkbox:
                    "<input type='checkbox' name='" + f.name + "'/><label for='" + f.name + "'>" + f.label + "</label>",
                submit:
                    "<input type='submit' value='" + f.value + "'/>"
            })[f.type] + "</td></tr>")

        ret + @"
    </table>
</form>"
    }

    def post(id, endpoint, button) => {
        _post(id, endpoint, [
            { text: "标题", type: "text", name: "subject" },
            { text: "名称", type: "text", name: "name" },
            { text: "选项", type: "text", name: "options" },
            { text: "正文", type: "textarea", name: "comment", rows: 10 },
            { text: "", type: "submit", value: button },
        ])
    }

    def postReply(id, endpoint, button) => {
        _post(id, endpoint, [
            { text: "名称", type: "text", name: "name" },
            { text: "选项", type: "text", name: "options" },
            { text: "正文", type: "textarea", name: "comment", rows: 10 },
            { text: "", type: "submit", value: button },
        ])
    }

    def this.index() => {
        var ret = header("首页")
        ret <+ post("start-new", "/new/0", "提交")
        ret <+ footer()
        ret
    }

    def tState(t) => @ret("") {
        if Bit.and(t.state, ThreadState.LOCKED)
            ret <+ "<div class='locked'>该串已被锁定</div>"

        if Bit.and(t.state, ThreadState.SAGED)
            ret <+ "<div class='saged'>该串已被sage</div>"
    }

    def this.timeline(threads) => {
        var ret = header("首页")
        ret <+ post("start-new", "/new/0", "提交")

        for threads do (t) => {
            ret <+ "<hr>"
            ret <+ _threadMain(t.main)

            if t.omitted > 0 
                ret <+ "<div class='omitted'>省略 " <+ t.omitted <+ " 篇回复，点击[回复]展开</div>"

            for t.replies do (reply) => {
                reply.isPO = reply.uid == t.main.uid

                ret <+ _thread(reply)
            }
        }

        ret <+ footer()
        ret
    }

    def this.thread(t) => {
        var ret = header("No." + t.main.id)
        if !Bit.and(t.main.state, ThreadState.LOCKED)
            ret <+ postReply("reply", "/new/" + t.main.id, "回复")

        ret <+ _threadMain(t.main)

        var ips = {}
        ips[Util.trimIP(t.main.ip)] = true

        var ids = {}
        ids[(var muid = t.main.uid)] = true

        for t.replies do (reply) => {
            reply.isPO = reply.uid == muid

            ret <+ _thread(reply)

            ips[Util.trimIP(reply.ip)] = true
            ids[reply.uid] = true
        }

        ret <+ "<div class='thread-info'>" <+ len(ips) <+ " / " <+ len(ids) <+ "</div>"
        ret <+ footer()
        ret
    }

    def _thread(t) => @ret("") {
        if t.isPO 
            t.name = "<span po>po</span>"

        ret <+ @"
        <div class='reply' id='thread-" <+ t.id <+ @"'>
            <div class='bar'>
                <div class='ind'></div>
                <span class='name'>" <+ 
                (t.name + "</span><span class='date'>" + 
                t.ts + "</span><span class='ref'>No.<a href='/thread/" + t.parent + "#thread-" + t.id + "'>" +
                t.id) <+ @"</a></span></div>
            <div class='comment'>" <+ t.comment <+ @"</div>
        </div>"
    }

    def _threadMain(t) => @ret("") {
        if t.isSticky
            var sticky = "<div class='sticky'>置顶</div>"

        ret <+ @"
        <div class='thread' id='thread-" <+ t.id <+ @"'>
            <div class='bar'>
                " <+ sticky <+ 
                ("" + (if t.subject != "untitled" "<span class='subject'>" + t.subject + "</span>") + 
                "</span><span class='name'>" + 
                t.name + "</span><span class='date'>" + 
                t.ts + "</span><span class='ref'>No." +
                t.id) <+ "</span><span>" <+
                "[ <a href='/thread/" <+ t.id <+ "'>回复 / <span class='replies'>" <+ 
                t.children <+ " 篇</span></a> ]" <+ @"</span>
            </div>
            <div class='comment'>" <+ t.comment <+ "</div>" <+
            tState(t) <+ @"
        </div>"
    }

    def pager(curPage) => @ret("") {
        ret <+ "<div class='pager'>"
    }

    def this.error(msg) => {
        var ret = header("错误")
        ret <+ msg
        ret <+ footer()
        ret
    }

    def this.info(msg) => {
        var ret = header("提示")
        ret <+ msg
        ret <+ footer()
        ret
    }
})()